name: CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install --legacy-peer-deps

    - name: Run tests and update README
      run: |
        echo "# CC1-DEVOPS" > README.md
        echo "" >> README.md
        echo "[![CI/CD](https://github.com/PierreGambaud/CC1-DEVOPS/actions/workflows/main.yml/badge.svg)](https://github.com/PierreGambaud/CC1-DEVOPS/actions/workflows/main.yml)" >> README.md
        echo "[![Netlify Status](https://api.netlify.com/api/v1/badges/7c5ab796-e192-4810-aa45-5a439e1bf90b/deploy-status)](https://app.netlify.com/sites/cc1-devops-pierre-gambiez-3info/deploys)" >> README.md
        echo "\n## Test Results\n" >> README.md
        echo "\`\`\`" >> README.md
        npm test | tee -a README.md
        echo "\`\`\`" >> README.md
        echo "\n## Deployment\n" >> README.md
        echo "This project is deployed on Netlify: [View Live Site](https://cc1-devops-pierre-gambiez-3info.netlify.app/)" >> README.md

    - name: Commit README
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add README.md
        git commit -m "Update README with test results and deployment URL" || echo "No changes to commit"
        git push

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install --legacy-peer-deps

    - name: Build
      run: npm run build

    - name: Deploy to Netlify
      uses: nwtgck/actions-netlify@v2.0
      with:
        publish-dir: './dist'
        production-branch: master
        deploy-message: "Deploy from GitHub Actions"
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
