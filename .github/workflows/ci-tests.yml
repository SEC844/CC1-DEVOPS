name: CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install --legacy-peer-deps

    - name: Run tests and update README
      run: |
        cat << 'EOF' > README.md
        # CC1-DEVOPS

        [![CI/CD](https://github.com/PierreGambaud/CC1-DEVOPS/actions/workflows/ci-tests.yml/badge.svg)](https://github.com/PierreGambaud/CC1-DEVOPS/actions/workflows/ci-tests.yml)
        [![Netlify Status](https://api.netlify.com/api/v1/badges/7c5ab796-e192-4810-aa45-5a439e1bf90b/deploy-status)](https://app.netlify.com/sites/cc1-devops-pierre-gambiez-3info/deploys)

        ![GitHub License](https://img.shields.io/github/license/PierreGambaud/CC1-DEVOPS?color=MIT)
        ![GitHub package.json version](https://img.shields.io/github/package-json/v/PierreGambaud/CC1-DEVOPS)
        ![GitHub Repo stars](https://img.shields.io/github/stars/PierreGambaud/CC1-DEVOPS)
        ![GitHub forks](https://img.shields.io/github/forks/PierreGambaud/CC1-DEVOPS)
        ![GitHub followers](https://img.shields.io/github/followers/PierreGambaud)
        ![GitHub issues](https://img.shields.io/github/issues/PierreGambaud/CC1-DEVOPS)
        ![GitHub closed issues](https://img.shields.io/github/issues-closed/PierreGambaud/CC1-DEVOPS)
        ![GitHub pull requests](https://img.shields.io/github/issues-pr/PierreGambaud/CC1-DEVOPS)
        ![GitHub dependencies](https://img.shields.io/librariesio/github/PierreGambaud/CC1-DEVOPS)
        ![GitHub repo size](https://img.shields.io/github/repo-size/PierreGambaud/CC1-DEVOPS)
        ![GitHub code size](https://img.shields.io/github/languages/code-size/PierreGambaud/CC1-DEVOPS)
        [![Build Status](https://travis-ci.com/PierreGambaud/CC1-DEVOPS.svg?branch=main)](https://travis-ci.com/PierreGambaud/CC1-DEVOPS)
        [![Build Status](https://travis-ci.org/PierreGambaud/CC1-DEVOPS.svg?branch=main)](https://travis-ci.org/PierreGambaud/CC1-DEVOPS)

        ## ðŸš€ Live Demo

        [https://cc1-devops-pierre-gambiez-3info.netlify.app/](https://cc1-devops-pierre-gambiez-3info.netlify.app/)

        ## ðŸ§ª Test Results

        \`\`\`
        EOF
        npm test >> README.md
        echo "\`\`\`" >> README.md

    - name: Commit README
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add README.md
        git commit -m "Update README with test results and deployment URL" || echo "No changes to commit"
        git push

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install --legacy-peer-deps

    - name: Build
      run: npm run build

    - name: Deploy to Netlify
      uses: nwtgck/actions-netlify@v2.0
      with:
        publish-dir: './dist'
        production-branch: master
        deploy-message: "Deploy from GitHub Actions"
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
